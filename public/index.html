<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Query</title>
  <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
  <div class="jumbotron">
    <h1 class="display-5">易班签到查询</h1>
    <small>@gaolihai</small>
    <hr class="my-4">
  </div>
  <div class="container">

    <div class="row" id="infoBox">
      <!-- info rendered location -->
    </div>

    <div class="row mt-5 justify-content-center">
      <div class="dropdown col-auto">
        <button class="btn btn-secondary dropdown-toggle" type="button" id="classesSwitcher" data-toggle="dropdown"
          aria-expanded="false">
          选择班级
        </button>

        <div class="dropdown-menu" aria-labelledby="classesSwitcher" id="classesSwitcherBox">
          <!-- classes rendered location -->
        </div>
      </div>
      <button type="button" class="btn btn-dark col-6" id="queryButton"> 查询 </button>
    </div>

    <div class="row mt-5">
      <div class="col">
        <div class="list-group" id="queryBox">
          <!-- check-in status rendered location -->
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"> </script>
  <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/4.6.0/js/bootstrap.bundle.min.js"> </script>
  <script src="https://cdn.bootcdn.net/ajax/libs/axios/0.21.1/axios.min.js"> </script>
  <script>
    // to be rendered element
    const classesSwitcherBox = $('#classesSwitcherBox');
    const queryBox = $('#queryBox');
    const infoBox = $('#infoBox');

    // actions element
    const classesSwitcher = $('#classesSwitcher');
    const queryButton = $('#queryButton');

    // list of student id array rendered under "global" scope
    let queryList = [];

    // render function
    function renderDropdown(classes) {
      classesSwitcherBox.html(classes.map(classobj => `<button class="dropdown-item" type="button" data-classname="${classobj.name}">${classobj.name}</button>`).join('\n'))
    }

    function renderErrorInfo(infoMessage) {
      infoBox.html(`
      <div class="col-12 alert alert-danger" role="alert">
        ${infoMessage}
      </div>
      `);
    }

    async function queryAndRender(stuid) {
      try {
        const result = await axios.get(`/yqfx/search?studentid=${stuid}`);
        if (/已签到/.test(result?.data ?? '')) {
          queryBox.append(`<div href="#" class="list-group-item list-group-item-action list-group-item-success">${stuid}<br> ${result?.data}</div>`).slideDown()
        } else {
          queryBox.append(`<div href="#" class="list-group-item list-group-item-action list-group-item-danger">${stuid}<br> ${result?.data}</div>`).slideDown()
        }
      } catch (error) {
        queryBox.append(`<div href="#" class="list-group-item list-group-item-action list-group-item-dark">${stuid}<br> 请求出错</div>`)
      }
    };

    // query action
    queryButton.on('click', async e => {
      if (queryBox.children().length >= 1) {
        await new Promise((resolve, reject) => {
          queryBox.children().slideUp(() => resolve(queryBox.html('')));
        });
      }
      try {
        await Promise.all(queryList.map(stuid => queryAndRender(stuid)))
      } catch (error) { /* ignore */ }
    });

    // async dropdown render
    (async () => {
      try {
        // dropdown data
        const config = (await axios.get('/config.json'))?.data;
        const classesArray = config?.classes;
        // data cache
        const classesMap = {}; config?.classes?.map?.(classobj => classesMap[classobj?.name] = classobj);
        // render dropdown
        renderDropdown(config.classes);
        // dropdown action
        classesSwitcherBox.on('click', e => {
          if (classesMap?.[$(e.target).data('classname')]) {
            queryList = classesMap[$(e.target).data('classname')]?.stuid;
            classesSwitcher.html($(e.target).data('classname'))
            $(e.target).siblings().removeClass('active');
            $(e.target).addClass().addClass('active');
          }
        });
        // render error message
      } catch (error) { renderErrorInfo(error.message); }
    })()

  </script>
</body>

</html>